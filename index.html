<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Batalla Naval – Áreas del Departamento (10x10)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --accent:#2dd4bf;
      --accent-2:#60a5fa;
      --muted:#93a4c0;
      --modal-bg: rgba(3, 6, 17, 0.7);
      --card:#0c162b;
      --radius:18px;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --cell: 44px;
      --label: 36px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#eaf2ff;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif}

    .stage{ position:fixed; inset:0; display:grid; place-items:center; padding:1.5vh; }
    .frame{
      height: min(95vh, 1000px);
      width:  min(97vw, 1600px);
      aspect-ratio: auto;
      background:linear-gradient(180deg, #0d1730, #0a1326);
      border-radius:24px; box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
      border:1px solid rgba(255,255,255,.05);
    }

    header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:rgba(255,255,255,.02);
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    header h1{font-size:1.1rem; margin:0; letter-spacing:.3px}
    header .sub{color:var(--muted); font-size:.85rem}

    .content{display:grid; grid-template-columns: 1fr 320px; gap:14px; padding:14px; height:100%}

    .board{
      background:var(--panel); border-radius:var(--radius); padding:16px; display:grid; gap:12px; align-content:center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: var(--label) repeat(10, var(--cell));
      grid-template-rows: var(--label) repeat(10, var(--cell));
      gap:8px;
      justify-content:center;
      align-content:center;
    }

    .glabel{
      display:grid; place-items:center;
      font-weight:700; font-size:.85rem; letter-spacing:.4px;
      color:#cfe7ff; background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      border-radius:10px;
      user-select:none;
      padding:2px 4px;
    }
    .glabel.corner{ background:transparent; border:0 }

    .cell{
      width: var(--cell);
      height: var(--cell);
      border-radius:10px; background:linear-gradient(180deg, #0f1b38, #0b152b); border:1px solid rgba(20, 149, 155, 0.524);
      display:grid; place-items:center; cursor:pointer; position:relative; overflow:hidden;
      transition: transform .12s ease, background .2s ease, border-color .2s ease, outline-color .2s ease;
      user-select:none;
    }
    .cell:hover{ transform: translateY(-2px); border-color:rgba(255,255,255,.18) }
    .cell.visited{ background:linear-gradient(180deg, #0c152d, #0a1226); border-color:rgba(255,255,255,.1) }
    .cell .marker{ position:absolute; bottom:6px; right:6px; font-size:.95rem; opacity:.9 }
    .cell.visited.hit  { outline: 2px solid rgba(22,163,74,.8); }
    .cell.visited.miss { outline: 2px solid rgba(239,68,68,.85); }

    .side{
      background:var(--panel); border-radius:var(--radius); padding:14px; display:grid; grid-auto-rows: min-content; gap:12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .metric{display:grid; gap:8px}
    .progress{height:10px; background:#0b1222; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .progress > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .35s ease}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(96,165,250,.12); border:1px solid rgba(96,165,250,.25); font-size:.8rem}
    .list{display:grid; gap:6px}

    .row{display:flex; gap:8px}
    button.reset{
      all:unset; cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:#0a1428; transition: background .2s ease; font-weight:600; font-size:.9rem;
    }
    button.reset:hover{ background:#0d1933 }

    footer{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-top:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:.85rem}

    /* Modal contenido */
    .modal-backdrop{ position:fixed; inset:0; background:var(--modal-bg); display:none; place-items:center; padding:24px; z-index:60 }
    .modal{ width:min(960px, 92vw); background:var(--card); border-radius:22px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.08); overflow:hidden }
    .modal header{ border:0; background:linear-gradient(180deg, rgba(45,212,191,.14), rgba(96,165,250,.10)); padding:16px 20px }
    .modal header h2{ margin:0; font-size:1.1rem }
    .modal .body{ padding:18px 20px; display:grid; gap:14px; line-height:1.6 }
    .modal .tags{ display:flex; flex-wrap:wrap; gap:8px }
    .tag{ padding:6px 10px; border-radius:999px; background:#0b1731; border:1px solid rgba(255,255,255,.08); font-size:.8rem; color:#cfe7ff }
    .modal .actions{ padding:14px 20px; display:flex; justify-content:flex-end; gap:10px; background:rgba(255,255,255,.02); border-top:1px solid rgba(255,255,255,.06) }
    .btn{ all:unset; cursor:pointer; padding:10px 14px; border-radius:10px; background:linear-gradient(180deg, #0f1c39, #0b1428); border:1px solid rgba(255,255,255,.12); font-weight:600 }
    .btn.primary{ background:linear-gradient(90deg, var(--accent), var(--accent-2)); color:#051022; border:0 }
    #btnPrev,#btnNext{ display:none; }

    /* Pantalla resultado previa */
    .result-backdrop{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:70 }
    .result-card{ min-width:280px; max-width:85vw; text-align:center; border-radius:18px; padding:22px 26px; border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); }
    .result-card.hit{ background:rgba(34,197,94,.18); }
    .result-card.miss{ background:rgba(239,68,68,.18); }
    .result-title{ font-size:1.6rem; font-weight:800; margin:0 0 6px }
    .result-sub{ color:#cfe7ff; font-size:.95rem }

    /* Final */
    .final-backdrop{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.85); z-index:100; color:white; }
    .final-card{ text-align:center; padding:40px 50px; border-radius:20px; background:linear-gradient(180deg, #0f1c39, #0b1428); box-shadow:0 0 30px rgba(0,0,0,.6); border:2px solid var(--accent-2); }
    .final-card h1{ font-size:2.5rem; margin:0 0 12px; color:var(--accent); }
    .final-card p{ font-size:1.2rem; margin:0; color:#cfe7ff; }

    /* === Showcase de FLOTA === */
    .flota-backdrop{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.7); z-index:75; }
    .flota-card{
      width:min(1100px, 96vw); min-height:min(72vh, 720px);
      background:linear-gradient(180deg, #0d1730, #0a1326);
      border:1px solid rgba(255,255,255,.12); border-radius:22px; box-shadow:var(--shadow);
      overflow:hidden; display:grid; grid-template-columns:1.3fr 0.9fr;
    }
    .flota-left{ position:relative; background:#071126; display:grid; place-items:center; overflow:hidden; }
    .flota-left img{ width:100%; height:100%; object-fit:cover; opacity:.9; filter:contrast(1.05) saturate(1.05); }

    .flota-banner{
      position:absolute; top:12px; left:12px; right:12px; background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#071126; font-weight:900; padding:10px 16px; border-radius:12px; text-align:center; letter-spacing:.4px;
      box-shadow:0 6px 20px rgba(0,0,0,.35);
    }

    /* Panel derecho centrado */
    .flota-right{
      padding:18px;
      display:grid;
      grid-template-rows:auto 1fr auto; /* Título / grid / botones */
      gap:12px;
      background:rgba(255,255,255,.02);
      min-height:0;
      justify-items:center;            /* centra horizontalmente */
    }

    .crew-title{ font-weight:800; font-size:1.05rem; text-align:center; }

    /* Grilla uniforme, centrada y responsiva */
    .crew-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      grid-auto-rows: 150px;           /* alto fijo de cada tarjeta */
      gap:14px;
      width:100%;
      max-width:520px;                 /* evita que se abra demasiado con pocas filas */
      place-content:center;            /* centra en ambos ejes si sobra espacio */
      justify-items:center;            /* centra cada tarjeta horizontalmente */
      align-items:center;              /* centra cada tarjeta verticalmente */
      padding:4px 8px;
      overflow:auto;                   /* scroll si hay muchos */
    }

    .crew-item{
      width:110px;
      height:150px;                    /* debe coincidir con grid-auto-rows */
      display:grid;
      grid-template-rows: auto auto 1fr;
      justify-items:center;
      gap:8px;
      text-align:center;
      color:#dfe9ff;
    }

    .crew-avatar{
      width:72px; height:72px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.2);
      overflow:hidden; display:grid; place-items:center;
      background:#0b1731; font-weight:800; letter-spacing:.3px;
    }
    .crew-avatar img{
      display:block;
      width:100%; height:100%;
      object-fit:cover; object-position:center; /* recorta al círculo */
    }

    .crew-name{
      max-width:100%;
      font-size:.82rem; font-weight:700; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .crew-role{
      font-size:.72rem; line-height:1.1; opacity:.75;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }

    .flota-actions{ display:flex; justify-content:flex-end; gap:10px; width:100%; }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,.25); }
  </style>
</head>
<body>
  <div class="stage">
    <div class="frame" role="application" aria-label="Batalla naval didáctica, tablero 10 por 10">
      <header>
        <div>
          <h1>Batalla Naval – Áreas del Departamento</h1>
          <div class="sub">Haz clic en cada casilla. Verás primero el resultado (<strong>IMPACTO!</strong> o <strong>¡Falló!</strong>) y, si corresponde, el detalle.</div>
        </div>
        <div class="row"><button class="reset" id="btnReset" title="Reiniciar tablero">Reiniciar</button></div>
      </header>

      <div class="content">
        <section class="board" aria-live="polite">
          <div class="grid" id="grid" aria-label="Cuadrícula 10 por 10 con encabezados externos"></div>
        </section>

        <aside class="side">
          <div class="metric">
            <div class="pill">Progreso del tablero</div>
            <div class="progress"><span id="bar"></span></div>
            <div id="progressText" class="sub">0 / 100 descubiertas</div>
          </div>
          <div class="metric">
            <div class="pill">Resumen</div>
            <div class="list" id="summary">
              <div>Impactos (flotas + misiones): <strong id="hits">0</strong>/10</div>
              <div>Falló (vacías): <strong id="misses">0</strong></div>
            </div>
          </div>
          <div class="metric">
            <div class="pill">Leyenda</div>
            <div class="list">
              <div>🟩 Verde: <strong>IMPACTO!</strong> (Flota o Misión con información)</div>
              <div>🟥 Rojo: <strong>Falló!</strong> (Casilla vacía)</div>
              <div>✔️ Casilla visitada</div>
            </div>
          </div>
        </aside>
      </div>

      <footer>
        <span>Tablero 10×10 • HTML/CSS/JS</span>
        <span id="status" class="sub">Listo para jugar</span>
      </footer>
    </div>
  </div>

  <!-- Modal de contenido -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <header><h2 id="modalTitle">Título</h2></header>
      <div class="body">
        <div id="modalDesc">Descripción</div>
        <div class="tags" id="modalTags"></div>
        <div id="modalHint" class="sub" style="opacity:.9;"></div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnClose" title="Cerrar">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Pantalla de resultado (previa) -->
  <div class="result-backdrop" id="resultBackdrop" aria-hidden="true">
    <div class="result-card" id="resultCard">
      <div class="result-title" id="resultTitle">IMPACTO!</div>
      <div class="result-sub" id="resultSub">Se abrirá el detalle…</div>
    </div>
  </div>

  <!-- Pantalla final -->
  <div class="final-backdrop" id="finalBackdrop">
    <div class="final-card">
      <h1>¡MISIÓN CUMPLIDA!</h1>
      <p>
        La flota de <strong>Estrategia de Gobierno y Monitoreo del Dato</strong><br />
        ha navegado todas sus misiones con éxito.<br /><br />
        Gracias por acompañarnos en este recorrido.<br />
        ¡Ahora continuamos con el resto de la travesía!
      </p>
    </div>
  </div>

  <!-- Showcase de FLOTA -->
  <div class="flota-backdrop" id="flotaBackdrop" aria-hidden="true">
    <div class="flota-card">
      <div class="flota-left">
        <img id="flotaCover" alt="Barco de la flota">
        <div class="flota-banner" id="flotaBanner">Flota X: Nombre</div>
      </div>
      <div class="flota-right">
        <div class="crew-title">Tripulación</div>
        <div class="crew-grid" id="crewGrid"></div>
        <div class="flota-actions">
          <button class="btn ghost" id="btnFlotaSkip" title="Saltar">Saltar</button>
          <button class="btn primary" id="btnFlotaContinue" title="Continuar">Continuar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Datos base ===== */
    const ROWS = ['A','B','C','D','E','F','G','H','I','J'];
    const COLS = ['1','2','3','4','5','6','7','8','9','10'];

    const SCRIPTED_ORDER = [
      'MISS',
      'FLOTA1','FLOTA2','MISS','FLOTA3','FLOTA4',
      'MISS','MISS','FLOTA5','MISS',
      'MISION1','MISION2','MISS','MISION3','MISS','MISION4','MISS','MISION5'
    ];

    /* ===== Flotas y Misiones (con covers y crew) ===== */
    const FLOTAS = {
      FLOTA1:{
        type:'flota', area:'Planificación de la Información',
        title:'Flota 1: Planificación de la Información',
        desc:'Coordina la planeación integral de la información del Ministerio.',
        cover:'https://images.unsplash.com/photo-1691045243893-090cb94b940c?q=80&w=1600&auto=format&fit=crop',
        crew:[
          { name:'Experto en Planificación', role:'Experto', photo:'https://images.unsplash.com/photo-1618641986557-1ecd230959aa?q=80&w=400&auto=format&fit=crop' },
          { name:'Profesional en Planificación', role:'Profesional', photo:'' }
        ],
        tags:['Temas: Identificación Oferta/Demanda, Diagnósticos, Plan Estadístico, Plan de Información, Mapas de información']
      },
      FLOTA2:{
        type:'flota', area:'Analítica de Datos e Infraestructura de Datos Estadísticos',
        title:'Flota 2: Analítica e Infraestructura de Datos',
        desc:'Desarrolla y opera la plataforma y el ecosistema analítico del Ministerio.',
        cover:'https://images.unsplash.com/photo-1698677671150-d9506d2eb8b9?q=80&w=1600&auto=format&fit=crop',
        crew:[
          { name:'Arq. Tecnología', role:'MS Azure' },
          { name:'Arq. de Datos', role:'Arquitecto' },
          { name:'DBA', role:'Base de Datos' },
          { name:'Especialista Analítica', role:'Analytics' },
          { name:'Especialista SIG', role:'SIG' },
          { name:'Desarrollador Web', role:'Web' },
          { name:'Diseñador Gráfico', role:'Diseño' },
          { name:'Esp. Interoperabilidad', role:'Interoperabilidad' },
          { name:'Admin. Bodega Datos', role:'Data Warehouse' },
          { name:'Analista de Reqs.', role:'Requerimientos' }
        ],
        tags:['Temas: Interoperabilidad, Calidad, Bodega de datos, Inteligencia de Negocios, ML/Big Data, Plataforma digital']
      },
      FLOTA3:{
        type:'flota', area:'Infraestructura de Datos Espaciales',
        title:'Flota 3: Infraestructura de Datos Espaciales',
        desc:'Lidera el componente geoespacial (SIGeográfico y SACD) para análisis y toma de decisión.',
        cover:'https://images.unsplash.com/photo-1712823715723-1f64db0f4c90?q=80&w=1600&auto=format&fit=crop',
        crew:[
          { name:'Especialista Analítica', role:'Analytics' },
          { name:'Especialista SIG', role:'SIG' },
          { name:'Especialista Interoperabilidad', role:'Interoperabilidad' },
          { name:'Analista de Reqs.', role:'Requerimientos' }
        ],
        tags:['Temas: SI Geográfico, SACD']
      },
      FLOTA4:{
        type:'flota', area:'Estudios Estratégicos',
        title:'Flota 4: Estudios Estratégicos',
        desc:'Investigación aplicada y evaluaciones para políticas públicas y decisiones sectoriales.',
        cover:'https://images.unsplash.com/photo-1729896972398-c39c4313eada?q=80&w=1600&auto=format&fit=crop',
        crew:[
          { name:'Matemático/a', role:'Investigación' },
          { name:'Científico/a de Datos', role:'Data Science' }
        ],
        tags:['Temas: Metodologías, Productos estadísticos, Investigaciones y análisis temáticos, Políticas públicas, Evaluaciones de impacto']
      },
      FLOTA5:{
        type:'flota', area:'Uso y Apropiación',
        title:'Flota 5: Uso y Apropiación',
        desc:'Gestión del conocimiento y adopción de IA y tecnologías emergentes.',
        cover:'https://images.unsplash.com/photo-1738105523354-18fb7e6297b9?q=80&w=1600&auto=format&fit=crop',
        crew:[
          { name:'Auditor/a', role:'Auditoría' },
          { name:'Investigador/a', role:'I+D+I' }
        ],
        tags:['Temas: Gestión/Uso/Apropiación del Conocimiento, I+D+I, Capacidades Analíticas e IA']
      },
    };

    const MISIONES = {
      MISION1:{ type:'mision', title:'Misión 1 – Planificación de la Información', desc:'¿Cuál es la misión de la Flota 1: Planificación de la Información?', tags:['Kahoot: lanza la pregunta asociada a Flota 1'] },
      MISION2:{ type:'mision', title:'Misión 2 – Analítica e Infraestructura de Datos', desc:'¿Cuál es la misión de la Flota 2: Analítica e Infraestructura de Datos?', tags:['Kahoot: lanza la pregunta asociada a Flota 2'] },
      MISION3:{ type:'mision', title:'Misión 3 – Infraestructura de Datos Espaciales', desc:'¿Cuál es la misión de la Flota 3: Infraestructura de Datos Espaciales?', tags:['Kahoot: lanza la pregunta asociada a Flota 3'] },
      MISION4:{ type:'mision', title:'Misión 4 – Estudios Estratégicos', desc:'¿Cuál es la misión de la Flota 4: Estudios Estratégicos?', tags:['Kahoot: lanza la pregunta asociada a Flota 4'] },
      MISION5:{ type:'mision', title:'Misión 5 – Uso y Apropiación', desc:'¿Cuál es la misión de la Flota 5: Uso y Apropiación?', tags:['Kahoot: lanza la pregunta asociada a Flota 5'] },
    };

    /* ===== Estado / elementos ===== */
    const gridEl = document.getElementById('grid');
    const hitsEl = document.getElementById('hits');
    const missesEl = document.getElementById('misses');
    const progressBar = document.getElementById('bar');
    const progressText = document.getElementById('progressText');
    const statusEl = document.getElementById('status');

    const backdrop = document.getElementById('backdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalTags = document.getElementById('modalTags');
    const modalHint = document.getElementById('modalHint');
    const btnClose = document.getElementById('btnClose');
    const btnReset = document.getElementById('btnReset');

    const resultBackdrop = document.getElementById('resultBackdrop');
    const resultCard = document.getElementById('resultCard');
    const resultTitle = document.getElementById('resultTitle');
    const resultSub = document.getElementById('resultSub');

    const finalBackdrop = document.getElementById('finalBackdrop');

    const flotaBackdrop = document.getElementById('flotaBackdrop');
    const flotaCover = document.getElementById('flotaCover');
    const flotaBanner = document.getElementById('flotaBanner');
    const crewGrid = document.getElementById('crewGrid');
    const btnFlotaContinue = document.getElementById('btnFlotaContinue');
    const btnFlotaSkip = document.getElementById('btnFlotaSkip');

    const LS_KEY = 'bn-10x10-scripted-v1';

    const assignments = {};
    let linearVisited = [];
    let state = { visited:new Set(), current:null, hits:0, misses:0, scriptIndex:0 };
    const shownFlotaShowcase = new Set();

    /* ===== Tablero ===== */
    function buildBoard(){
      gridEl.innerHTML = '';

      const corner = document.createElement('div');
      corner.className = 'glabel corner';
      gridEl.appendChild(corner);

      COLS.forEach(c=>{
        const th = document.createElement('div');
        th.className='glabel top';
        th.textContent=c;
        th.setAttribute('aria-hidden','true');
        gridEl.appendChild(th);
      });

      ROWS.forEach(r=>{
        const rh = document.createElement('div');
        rh.className='glabel left';
        rh.textContent=r;
        rh.setAttribute('aria-hidden','true');
        gridEl.appendChild(rh);

        COLS.forEach(c=>{
          const id = `${r}${c}`;
          const btn = document.createElement('button');
          btn.className='cell';
          btn.setAttribute('data-id', id);
          btn.setAttribute('aria-label', `Casilla ${id}`);
          btn.innerHTML = `<span class="marker" aria-hidden="true"></span>`;
          btn.addEventListener('click', ()=> onCellClick(id));
          gridEl.appendChild(btn);
        });
      });

      restoreState();
      updateHUD();
    }

    /* ===== Click + orden arreglado ===== */
    function onCellClick(id){
      if(state.visited.has(id)){
        const a = assignments[id];
        if(a && a.kind==='hit'){
          state.current = id;
          const info = getInfoFromAssignment(a);
          openModal(info, id);
        }
        return;
      }

      const script = SCRIPTED_ORDER[state.scriptIndex] || 'MISS';
      let outcome = { kind:'miss' };

      if (script.startsWith('FLOTA') && FLOTAS[script]) { outcome = { kind:'hit', key:script }; }
      else if (script.startsWith('MISION') && MISIONES[script]) { outcome = { kind:'hit', key:script }; }
      else { outcome = { kind:'miss' }; }

      assignments[id] = outcome;
      state.scriptIndex = Math.min(state.scriptIndex + 1, SCRIPTED_ORDER.length);

      showResultScreen(outcome, ()=>{
        markVisited(id, outcome);
        if(outcome.kind === 'hit'){
          const info = getInfoFromAssignment(outcome);
          state.current = id;
          if(outcome.key.startsWith('FLOTA') && !shownFlotaShowcase.has(outcome.key)){
            shownFlotaShowcase.add(outcome.key);
            openFlotaShowcase(info, ()=> openModal(info, id));
          }else{
            openModal(info, id);
          }
        }
      });
    }

    function getInfoFromAssignment(a){
      if(a.kind!=='hit') return null;
      if(a.key.startsWith('FLOTA')) return FLOTAS[a.key];
      if(a.key.startsWith('MISION')) return MISIONES[a.key];
      return null;
    }

    /* ===== Resultado previo ===== */
    function showResultScreen(outcome, onDone){
      const isHit = outcome.kind === 'hit';
      resultCard.classList.remove('hit','miss');
      resultCard.classList.add(isHit ? 'hit' : 'miss');
      resultTitle.textContent = isHit ? '¡IMPACTO!' : '¡FALLÓ!';
      resultSub.textContent = isHit ? 'Abriendo bitácora del capitan…' : 'Sigue intentando.';
      resultBackdrop.style.display='grid';
      resultBackdrop.setAttribute('aria-hidden','false');

      setTimeout(()=>{
        resultBackdrop.style.display='none';
        resultBackdrop.setAttribute('aria-hidden','true');
        onDone && onDone();
      }, 850);
    }

    /* ===== Modal ===== */
    function openModal(info){
      if(!info) return;

      modalTags.innerHTML='';
      (info.tags||[]).forEach(t=>{
        const tag=document.createElement('span');
        tag.className='tag';
        tag.textContent=t;
        modalTags.appendChild(tag);
      });

      if(info.type==='flota'){
        modalTitle.textContent = info.title;
        modalDesc.textContent = info.desc || '';
        modalHint.textContent = 'Exponer brevemente las funciones y roles de la flota. (Los tripulantes deben prestar atención: habrá una misión en Kahoot sobre esta flota).';
      }else{
        modalTitle.textContent = info.title || 'Misión';
        modalDesc.textContent = info.desc || '';
        modalHint.textContent = 'Vamos a Kahoot para completar la misión. Al finalizar, regresa y presiona “Cerrar”.';
      }

      backdrop.style.display='grid';
      backdrop.setAttribute('aria-hidden','false');
      setTimeout(()=>{ btnClose.focus(); }, 0);
    }

    function closeModal(){
      backdrop.style.display='none';
      backdrop.setAttribute('aria-hidden','true');

      if(state.current){
        const a = assignments[state.current];
        if(a && a.key === 'MISION5'){ showFinalScreen(); }
      }
      state.current = null;
    }

    /* ===== Showcase de FLOTA ===== */
    function openFlotaShowcase(flotaInfo, onContinue){
      flotaCover.src = flotaInfo.cover || '';
      flotaCover.alt = `Barco – ${flotaInfo.area || ''}`;
      flotaBanner.textContent = flotaInfo.title || 'Flota';

      crewGrid.innerHTML='';
      (flotaInfo.crew || []).forEach(member=>{
        const item = document.createElement('div');
        item.className='crew-item';

        const av = document.createElement('div');
        av.className='crew-avatar';

        if(member.photo){
          const img = document.createElement('img');
          img.src = member.photo;
          img.alt = member.name || 'Tripulante';
          av.appendChild(img);
        }else{
          const initials = (member.name || 'Tripulante')
            .split(/\s+/).map(w => w[0]?.toUpperCase() || '').slice(0,2).join('');
          av.textContent = initials || 'T';
        }

        const nameEl = document.createElement('div');
        nameEl.className = 'crew-name';
        nameEl.textContent = member.name || 'Tripulante';

        const roleEl = document.createElement('div');
        roleEl.className = 'crew-role';
        roleEl.textContent = member.role || '';

        item.appendChild(av);
        item.appendChild(nameEl);
        item.appendChild(roleEl);
        crewGrid.appendChild(item);
      });

      flotaBackdrop.style.display='grid';
      flotaBackdrop.setAttribute('aria-hidden','false');

      const cont = ()=>{
        flotaBackdrop.style.display='none';
        flotaBackdrop.setAttribute('aria-hidden','true');
        onContinue && onContinue();
      };
      btnFlotaContinue.onclick = cont;
      btnFlotaSkip.onclick = cont;
    }

    /* ===== Final ===== */
    function showFinalScreen(){ document.getElementById('finalBackdrop').style.display='grid'; }

    /* ===== Marcar visita y HUD ===== */
    function markVisited(id, outcome){
      if(state.visited.has(id)) return;
      state.visited.add(id);
      linearVisited.push(id);

      const cellEl = gridEl.querySelector(`[data-id="${id}"]`);
      if(cellEl){
        cellEl.classList.add('visited');
        const marker = cellEl.querySelector('.marker');

        if(outcome.kind==='hit'){
          cellEl.classList.add('hit');
          const info = getInfoFromAssignment(outcome);
          marker.textContent = (info && info.type === 'flota') ? '🚢 ✔️' : '🎯 ✔️';
          marker.setAttribute('title','IMPACTO!');
          state.hits++;
        }else{
          cellEl.classList.add('miss');
          marker.textContent = '✖️';
          marker.setAttribute('title','Falló!');
          state.misses++;
        }
      }
      updateHUD();
      maybeFinish();
      persistState();
    }

    function updateHUD(){
      const total = state.visited.size;
      if (hitsEl) hitsEl.textContent = state.hits;
      if (missesEl) missesEl.textContent = state.misses;
      if (progressBar) progressBar.style.width = `${(total/100)*100}%`;
      if (progressText) progressText.textContent = `${total} / 100 descubiertas`;
      if (statusEl) statusEl.textContent = total === 100 ? 'Completado' : (total > 0 ? 'En progreso' : 'Listo para jugar');
    }
    function maybeFinish(){ /* opcional: toast cuando llegue a 100 */ }
    function persistState(){
      try{
        const data = { a:assignments, v:[...state.visited], lv:linearVisited, h:state.hits, m:state.misses, si:state.scriptIndex, sf:[...shownFlotaShowcase] };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }catch(e){}
    }
    function restoreState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        Object.assign(assignments, data.a || {});
        linearVisited = data.lv || [];
        state.visited = new Set(data.v || []);
        state.hits = data.h || 0;
        state.misses = data.m || 0;
        state.scriptIndex = data.si || 0;
        (data.sf || []).forEach(k => shownFlotaShowcase.add(k));

        state.visited.forEach(id=>{
          const a = assignments[id] || {kind:'miss'};
          const cellEl = gridEl.querySelector(`[data-id="${id}"]`);
          if(cellEl){
            cellEl.classList.add('visited', a.kind==='hit' ? 'hit' : 'miss');
            const marker = cellEl.querySelector('.marker');
            if(a.kind==='hit'){
              const info = getInfoFromAssignment(a);
              marker.textContent = (info && info.type === 'flota') ? '🚢 ✔️' : '🎯 ✔️';
              marker.setAttribute('title','IMPACTO!');
            }else{
              marker.textContent = '✖️';
              marker.setAttribute('title','Falló!');
            }
          }
        });
      }catch(e){}
    }

    /* ===== Tamaño de celdas ===== */
    function readCSSVar(name, fallback){
      const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function resizeGrid(){
      const frame = document.querySelector('.frame');
      const header = frame.querySelector('header');
      const footer = frame.querySelector('footer');
      const contentPadY = 28;

      const frameH = frame.clientHeight;
      const availH = frameH - header.offsetHeight - footer.offsetHeight - contentPadY;

      const board = document.querySelector('.board');
      const grid  = document.getElementById('grid');

      const boardStyles = getComputedStyle(board);
      const boardPadX = parseFloat(boardStyles.paddingLeft) + parseFloat(boardStyles.paddingRight);
      const boardW = board.clientWidth - boardPadX;

      const gridStyles = getComputedStyle(grid);
      const gap = parseFloat(gridStyles.gap) || 8;

      const label = readCSSVar('--label', 36);
      const cols = COLS.length, rows = ROWS.length;

      const cellByW = Math.floor((boardW - label - gap*cols) / cols);
      const cellByH = Math.floor((availH - label - gap*rows) / rows);

      const cell = Math.max(28, Math.min(cellByW, cellByH));
      document.documentElement.style.setProperty('--cell', cell + 'px');
    }
    window.addEventListener('resize', resizeGrid);
    window.addEventListener('orientationchange', resizeGrid);

    /* ===== Eventos ===== */
    document.getElementById('btnClose').addEventListener('click', closeModal);
    document.getElementById('backdrop').addEventListener('click', (e)=>{ if(e.target === backdrop) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(backdrop.style.display === 'grid' && e.key === 'Escape') closeModal(); });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      localStorage.removeItem(LS_KEY);
      for(const k in assignments) delete assignments[k];
      linearVisited = [];
      state = { visited:new Set(), current:null, hits:0, misses:0, scriptIndex:0 };
      shownFlotaShowcase.clear();
      buildBoard(); resizeGrid();
    });

    /* Init */
    buildBoard();
    resizeGrid();
  </script>
</body>
</html>
